{% extends 'index.html' %}
{% block content %}
    <form class="login-form" id="editprofile" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="d-flex justify-content-between align-items-end mb-4">
            <h3 class="mb-0"><b>Edit profile</b></h3>
        </div>
        <br>
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">First Name</label>
                <input type="text" class="form-control" name="first_name" value="{{ firstName }}" required>
            </div>
            <div class="col-md-6">
                <label class="form-label">Surname</label>
                <input type="text" class="form-control" name="last_name" value="{{ lastName }}" required>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">Email</label>
                <input type="email" class="form-control" name="email" id="emailInput"
                       value="{{ email }}" required>
                <small id="emailFeedback" class="form-text"></small>
            </div>
            <div class="col-md-6">
                <label class="form-label">Phone Number</label>
                <input type="tel" class="form-control" name="phone"
                       value="{{ phone }}" required>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">Nationality</label>
                <select class="form-control" name="nationality" required>
                    {% if nationality %}
                        <option value="{{ nationalityId }}" selected>{{ nationality }}</option>
                    {% else %}
                        <option value="" selected>-- Select Nationality --</option>
                    {% endif %}

                    {% for country in countries %}
                        <option value="{{ country.id }}">{{ country.nationality }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-6">
                <label class="form-label">County</label>
                <select id="county" name="county" class="form-control" required>
                    {% if county %}
                        <option value="{{ countyId }}" selected>{{ county }}</option>
                    {% else %}
                        <option value="">-- Select County --</option>
                    {% endif %}
                    {% for c in counties %}
                        <option value="{{ c.id }}">{{ c.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">Subcounty</label>
                <select id="subcounty" name="subcounty" class="form-control" required>
                    {% if subcounty %}
                        <option value="{{ subcountyId }}" selected>{{ subcounty }}</option>
                    {% else %}
                        <option value="">-- Select Subcounty --</option>
                    {% endif %}
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label">Gender</label>
                <select class="form-control" name="gender" required>
                    {% if gender %}
                        <option value="{{ genderId }}" selected>{{ gender }}</option>
                    {% else %}
                        <option value="">-- Select Gender --</option>
                    {% endif %}

                    {% for mygender in genders %}
                        <option value="{{ mygender.id }}">{{ mygender.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="d-grid mt-4">
            <button type="submit" class="btn btn-primary">Update Profile</button>
        </div>
    </form>

<script>
    document.getElementById('editprofile').addEventListener('submit', function (e) {
        e.preventDefault();  // Prevent default form submission

        Swal.fire({
            title: 'Are you sure?',
            html: `<p>Updating some details like email or phone may affect your login credentials.</p><p>Do you wish to proceed?</p>`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, update profile',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                const form = e.target;
                const formData = new FormData(form);

                fetch("{% url 'saveEditProfile' %}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                    },
                    body: formData
                })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        Swal.fire({
                            icon: 'success',
                            title: 'Profile Updated',
                            text: 'Your changes were saved successfully.'
                        }).then(() => {
                            window.location.href = "{% url 'Myprofile' %}";
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: data.message
                        });
                    }
                });
            }
        });
    });
</script>


{% endblock %}